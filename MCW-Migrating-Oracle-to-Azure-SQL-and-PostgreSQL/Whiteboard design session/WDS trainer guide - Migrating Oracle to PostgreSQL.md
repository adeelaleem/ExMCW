
![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/main/Media/ms-cloud-workshop.png "Microsoft Cloud Workshops")

<div class="MCWHeader1">
Migrating Oracle to PostgreSQL
</div>

<div class="MCWHeader2">
Whiteboard design session trainer guide
</div>

<div class="MCWHeader3">
September 2021
</div>

Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.

Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.

The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein.

© 2021 Microsoft Corporation. All rights reserved.

Microsoft and the trademarks listed at <https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx> are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.

**Contents**

- [Migrating Oracle to PostgreSQL whiteboard design session trainer guide](#migratingoracletopostgresql-whiteboard-design-session-trainer-guide)
- [Trainer information](#trainer-information)
  - [Role of the trainer](#role-of-the-trainer)
  - [Whiteboard design session flow](#whiteboard-design-session-flow)
  - [Before the whiteboard design session: How to prepare](#before-the-whiteboard-design-session-how-to-prepare)
  - [During the whiteboard design session: Tips for an effective whiteboard design session](#during-the-whiteboard-design-session-tips-for-an-effective-whiteboard-design-session)
- [Migrating Oracle to PostgreSQL whiteboard design session student guide](#migrating-oracle-to-postgresql-whiteboard-design-session-student-guide)
  - [Abstract](#abstract)
  - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study)
    - [Customer situation](#customer-situation)
    - [Customer needs](#customer-needs)
    - [Customer objections](#customer-objections)
    - [Infographic for common scenarios](#infographic-for-common-scenarios)
  - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution)
  - [Step 3: Present the solution](#step-3-present-the-solution)
  - [Wrap-up](#wrap-up)
  - [Additional references](#additional-references)
- [Migrating Oracle to PostgreSQL whiteboard design session trainer guide](#migrating-oracle-to-postgresql-whiteboard-design-session-trainer-guide)
  - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study-1)
  - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution-1)
  - [Step 3: Present the solution](#step-3-present-the-solution-1)
  - [Wrap-up](#wrap-up-1)
  - [Preferred target audience](#preferred-target-audience)
  - [Preferred solution](#preferred-solution)
  - [Checklist of preferred objection handling](#checklist-of-preferred-objection-handling)
  - [Customer quote (to be read back to the attendees at the end)](#customer-quote-to-be-read-back-to-the-attendees-at-the-end)

# Migrating Oracle to PostgreSQL whiteboard design session trainer guide

# Trainer information

Thank you for taking time to support the whiteboard design sessions as a trainer!

## Role of the trainer

An amazing trainer:

- Creates a safe environment in which learning can take place.

- Stimulates the participant's thinking.

- Involves the participant in the learning process.

- Manages the learning process (on time, on topic, and adjusting to benefit participants).

- Ensures individual participant accountability.

- Ties it all together for the participant.

- Provides insight and experience to the learning process.

- Effectively leads the whiteboard design session discussion.

- Monitors quality and appropriateness of participant deliverables.

- Effectively leads the feedback process.

## Whiteboard design session flow

Each whiteboard design session uses the following flow:

**Step 1: Review the customer case study (15 minutes)**

**Outcome**

Analyze your customer's needs.

- Customer's background, situation, needs and technical requirements

- Current customer infrastructure and architecture

- Potential issues, objectives and blockers

**Step 2: Design a proof of concept solution (60 minutes)**

**Outcome**

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

- Determine your target customer audience.

- Determine customer's business needs to address your solution.

- Design and diagram your solution.

- Prepare to present your solution.

**Step 3: Present the solution (30 minutes)**

**Outcome**

Present solution to your customer:

- Present solution

- Respond to customer objections

- Receive feedback

**Wrap-up (15 minutes)**

- Review preferred solution

## Before the whiteboard design session: How to prepare

Before conducting your first whiteboard design session:

- Read the Student guide (including the case study) and Trainer guide.

- Become familiar with all key points and activities.

- Plan the point you want to stress, which questions you want to drive, transitions, and be ready to answer questions.

- Prior to the whiteboard design session, discuss the case study to pick up more ideas.

- Make notes for later.

## During the whiteboard design session: Tips for an effective whiteboard design session

**Refer to the Trainer guide** to stay on track and observe the timings.

**Do not expect to memorize every detail** of the whiteboard design session.

When participants are doing activities, you can **look ahead to refresh your memory**.

- **Adjust activity and whiteboard design session pace** as needed to allow time for presenting, feedback, and sharing.

- **Add examples, points, and stories** from your own experience. Think about stories you can share that help you make your points clearly and effectively.

- **Consider creating a "parking lot"** to record issues or questions raised that are outside the scope of the whiteboard design session or can be answered later. Decide how you will address these issues, so you can acknowledge them without being derailed by them.

***Have fun**! Encourage participants to have fun and share!*

**Involve your participants.** Talk and share your knowledge but always involve your participants, even while you are the one speaking.

**Ask questions** and get them to share to fully involve your group in the learning process.

**Ask first**, whenever possible. Before launching into a topic, learn your audience's opinions about it and experiences with it. Asking first enables you to assess their level of knowledge and experience, and leaves them more open to what you are presenting.

**Wait for responses**. If you ask a question such as, "What's your experience with (fill in the blank)?" then wait. Do not be afraid of a little silence. If you leap into the silence, your participants will feel you are not serious about involving them and will become passive. Give participants a chance to think, and if no one answers, patiently ask again. You will usually get a response.

# Migrating Oracle to PostgreSQL whiteboard design session student guide

## Abstract

In this whiteboard design session, you work with a group to design a proof of concept (POC) for conducting a site analysis for a customer to compare cost, performance, and level of effort required to migrate from Oracle to Azure Database for PostgreSQL. You evaluate the dependent applications and reports that need to be updated and come up with a migration plan. Also, you review ways to help the customer take advantage of new PostgreSQL features to improve performance and resiliency and consider the impact of migrating from on-premises to the cloud.

At the end of this whiteboard design session, you will be better able to design a database migration plan and implementation.

## Step 1: Review the customer case study

**Outcome**

Analyze your customer’s needs.

Timeframe: 15 minutes

Directions: With all participants in the session, the facilitator/SME presents an overview of the customer case study along with technical tips.

1. Meet your table participants and trainer.

2. Read all of the directions for steps 1-3 in the student guide.

3. As a table team, review the following customer case study.

### Customer situation

World Wide Importers (WWI) has experienced massive growth over the last few years. That growth has resulted in a tremendous influx of new data they need to maintain their business. This data has become increasingly expensive to store in an Oracle relational database management system (RDBMS). Oracle upgrades are tedious and expensive projects. Business stakeholders have tired of the process and have requested a proof of concept (POC) for replacing Oracle with Azure Database for PostgreSQL. Azure Database for PostgreSQL brings many benefits to the table, including excellent performance, support for high-availability, and enterprise security features like AD support.

WWI is investigating ways to improve the performance of their transactional databases without incurring expensive new license fees. They're also concerned with keeping their transactional system available and online for their store. They've noticed that Oracle has been slowing down as their growth has doubled. They realize that they would need to invest in new hardware to achieve this on-premises and, as a result, are looking at this as more of a migration to a new system.

WWI has several external and internal applications that need to migrate with the database. The database is used by an online store application, written in ASP.NET Core MVC. They also have internal applications that manage their product catalog, written in Oracle Forms. In addition, they have many reports to aid in forecasting, sales reporting, and inventory maintenance. Those reports are a mixture of Power BI, Excel, and Oracle Forms, and hit the Oracle OLTP database directly.

WWI also uses this database to interact with vendors. Several of their vendors require real-time access to their sales data through an API so they can draw warranty information on the date of sale. They do this through a Representational State Transfer (REST) service that is maintained by WWI.

Before WWI invests in this project, they want a proof of concept that encompasses these touchpoints and proves that it can be successful.

WWI also has a new requirement. They have an existing web service that interacts with a vendor to get the latest certifications of that vendor's products. The JSON parser sometimes fails, and they can't figure out why. They'd like to store the original, unparsed JSON in a table for troubleshooting purposes. They would like to be able to query the JSON data by date or other identifying pieces of the JSON that might be available for troubleshooting and are interested in learning more about the best way to do that.

Also, they had a significant outage last year because one of their audit tables ran out of space. They had to wait many hours to resolve the issue while their IT department scrambled to make space on an already overloaded Storage Area Network (SAN). They would like a full briefing on how to monitor that situation, so it doesn't happen again, and possible remedies if it does happen again. They would also like high availability to be built into the project plan and are wondering what additional fees that would incur.

Kathleen Sloan, the CIO of WWI, is looking to decrease their software license fees, take advantage of a modern data warehouse, and provide a strong vision of availability for the future that can handle their momentous growth. She is sold on PostgreSQL, but her Oracle DBAs keep telling her that migration to PostgreSQL is simply impossible. They cite that they have never done it before. They say it's hard to find tools that make it possible. The Oracle DBAs say that PostgreSQL is not as high performing as Oracle, does not have great high availability like Oracle Real Application Clusters (RAC), and doesn't have a replacement for Oracle Forms. She's tired of hearing "no" whenever the topic is brought up and would love to prove them wrong. She is also exploring the cloud and is wondering if she can make a direct migration to a cloud database or if she must stay on-premises because of her requirements. She has seen PostgreSQL make tremendous gains in features over the last several versions, particularly in performance and high availability.

### Customer needs

1. Wants to migrate an existing Oracle database to PostgreSQL on-premises, PostgreSQL in an Azure VM, or Azure Database for PostgreSQL.

2. Need to know what's involved in migrating the external sales application to PostgreSQL.

3. Wants a better understanding of what to do with the internal Oracle Forms application.

4. Has multiple touchpoints with external vendors and wants to know what needs to change with those web services.

5. Need web-based visualizations on sales and forecasting, and a plan on how to upgrade their existing reporting infrastructure.

6. Have a new requirement on what to do with JSON data.

7. They experienced an outage last year and are hyper concerned with not repeating that experience. The audit table filled up, and they ran out of disk space. They'd like to know what would have happened if Azure Database for PostgreSQL experienced the same issue and what your solution would be.

8. As a follow-up, they'd also like to know how to answer the Oracle DBA's allegation that Azure Database for PostgreSQL doesn't have an answer for Oracle RAC.

### Customer objections

1. Do we need to upgrade to on-premises PostgreSQL first or go can we go straight to Azure?

2. Can we have two proofs of concept that demonstrate both migrations?

3. Do we need to rewrite all our applications for Azure Database for PostgreSQL?

4. Do we need to rewrite all our reports in Power BI?

5. Will our security migrate over from Oracle to Azure Database for PostgreSQL? How do we handle security in the new database?

6. Do we need to invest in a JSON storage system for the JSON data we're storing from our vendor's web service?

7. What will we do if our audit logs fill up again? Will Azure Database for PostgreSQL crash the same way Oracle did?

8. If we take advantage of new features, will our license costs keep ratcheting up and up? Will we have a dependable way of budgeting for this project?

9. Are there any Oracle features required by WWI for which Azure Database for PostgreSQL has no equivalent?

10. Do we need to tell all our vendors that we're changing databases, so their integrations work?

11. What will happen with Power BI?

### Infographic for common scenarios

![This common scenario diagram includes the following elements: API App for vendor connections; Web App for Internet Sales Transactions; Oracle Forms App for inventory management; Oracle DB OLTP RAC Server; and Power BI and Excel for reporting of OLTP.](media/common-scenarios-oracle-to-postgresql.png "Common Scenario diagram")

## Step 2: Design a proof of concept solution

**Outcome**

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 60 minutes

**Business needs**

Directions:  With all participants at your table, answer the following questions and list the answers on a flip chart:

1. Who should you present this solution to? Who is your target customer audience? Who are the decision makers?

2. What customer business needs do you need to address with your solution?

**Design**

Directions: With all participants at your table, respond to the following questions on a flip chart:

*High-level architecture*

1. Without getting into the details (they are addressed in the following sections), diagram your initial vision for handling the top-level requirements for data loading, data preparation, storage, high availability, application migration, and reporting. You will refine this diagram as you proceed.

2. What should be included in the POC?

3. How will Azure Database for PostgreSQL save them on licensing costs?

*Schema and data movement*

1. How would you recommend that WWI move their data and schema into PostgreSQL? What services would you suggest and what are the specific steps they would need to take to prepare the data, to transfer the data, and where would the loaded data land?

2. Update your diagram with the data loading process with the steps you identified.

*Application changes*

1. What product would you recommend to WWI to migrate their storefront MVC application to the new PostgreSQL database?

2. How would you migrate the Oracle Forms applications? How would you define success? Are there any technologies the customer needs to know?

3. What will you do about the vendor touchpoints? How will you recommend they store the JSON data?

*Reporting*

1. How can they discover which reports and Excel spreadsheets hitting the Oracle database need to be upgraded? What's a proper upgrade path?

*High Availability and Audit Table*

1. If our solution were PostgreSQL, what could WWI have done with the audit table when it filled up?

2. What are the PostgreSQL options for high availability?

*Azure Database for PostgreSQL POC*

1. Should they move to on-premises first?

2. Is there any benefit to going straight to Microsoft Azure? Does Azure Database for PostgreSQL take care of all their requirements?

3. Are there any questions we need to answer before we can begin a POC directly to Microsoft Azure?

**Prepare**

Directions: With all participants at your table:

1. Identify any customer needs that are not addressed with the proposed solution.

2. Identify the benefits of your solution.

3. Determine how you will respond to the customer's objections.

Prepare a 15-minute chalk-talk style presentation to the customer.

## Step 3: Present the solution

**Outcome**

Present a solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 30 minutes

**Presentation**

Directions:

1. Pair with another table.

2. One table is the Microsoft team and the other table is the customer.

3. The Microsoft team presents their proposed solution to the customer.

4. The customer makes one of the objections from the list of objections.

5. The Microsoft team responds to the objection.

6. The customer team gives feedback to the Microsoft team.

7. Tables switch roles and repeat Steps 2-6.

## Wrap-up

Timeframe: 15 minutes

Directions: Tables reconvene with the larger group to hear the facilitator/SME share the preferred solution for the case study.

## Additional references

|                                                          |                                                                                                                               |
| -------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| **Description**                                          | **Links**                                                                                                                     |
| Migrate Oracle to Azure Database for PostgreSQL          | <https://docs.microsoft.com/azure/postgresql/howto-migrate-from-oracle>                                                                |
| Azure Database for PostgreSQL features                              | <https://azure.microsoft.com/en-us/services/postgresql/>  |
| Older Oracle Forms Migration guide                       | <https://technet.microsoft.com/library/bb463141.aspx/> <https://www.microsoft.com/sql-server/sql-license-migration/>          |
| Azure Database Migration Service Overview                | <https://docs.microsoft.com/azure/dms/dms-overview>                                                                           |
| Differentiating Microsoft's database migration tools     | <https://blogs.msdn.microsoft.com/datamigration/2017/10/13/differentiating-microsofts-database-migration-tools-and-services/> |

# Migrating Oracle to PostgreSQL whiteboard design session trainer guide

## Step 1: Review the customer case study

- Check in with your table participants to introduce yourself as the trainer.

- Ask, "What questions do you have about the customer case study?"

- Briefly review the steps and timeframes of the whiteboard design session.

- Ready, set, go! Let the table participants begin.

## Step 2: Design a proof of concept solution

- Check in with your tables to ensure that they are transitioning from step to step on time.

- Provide some feedback on their responses to the business needs and design.

  - Try asking questions first that will lead the participants to discover the answers on their own.

- Provide feedback for their responses to the customer's objections.

  - Try asking questions first that will lead the participants to discover the answers on their own.

## Step 3: Present the solution

- Determine which table will be paired with your table before Step 3 begins.

- For the first round, assign one table as the presenting team and the other table as the customer.

- Have the presenting team present their solution to the customer team.

  - Have the customer team provide one objection for the presenting team to respond to.

  - The presentation, objections, and feedback should take no longer than 15 minutes.

  - If needed, the trainer may also provide feedback.

## Wrap-up

- Have the table participants reconvene with the larger session group to hear the facilitator/SME share the following preferred solution.

## Preferred target audience

- Kathleen Sloan, CIO of World Wide Importers (WWI)

- The primary audience is business and technology decision-makers. From the case study scenario, it would include the Director of Analytics. Usually we talk to the infrastructure managers who report to the chief information officers (CIOs), or to application sponsors, such as a line of business (LOB) vice president (VP), chief marketing officer (CMO), or to those who represent the business unit IT or developers who report to application sponsors.

## Preferred solution

*High-level architecture*

1. Without getting into the details (they are addressed in the following sections), diagram your initial vision for handling the top-level requirements for data loading, data preparation, storage, high availability, application migration, and reporting. You will refine this diagram as you proceed.

    After speaking with its support team at Microsoft, WWI decided that Azure Database for PostgreSQL would be the right choice for the Oracle OLTP replacement. They decided to load schema and data using **ora2pg** and migrate their Oracle Forms application using Microsoft ASP.NET Core. They are very concerned about how to do this and what method to use. They are leaning towards a total rewrite to ASP.NET Core. They would like the POC to include this. The POC should demonstrate that Azure Database for PostgreSQL will provide them the reliability and performance they expected Oracle to deliver for them.

    The solution they've decided on, at a high level, appears as follows: 

    ![This solution diagram is divided into Microsoft Azure and on-premises. Azure Database for PostgreSQL serves as the primary OLTP database with support for the efficient analysis of JSON data. It is also possible to use the Hyperscale (Citus) offering. Citus supports high availability, which entails pairing two instances to serve as a single node. When one of the instances fails, the other instance--which is kept up to date--is substituted automatically. Logs generated by PostgreSQL's standard logging tools and pgAudit will be stored in Azure Monitor, a tool which allows the analysis of logging data. As for on-premises components, the API app for vendor connections, the Web App for Internet Sales Transactions, and the ASP.NET Core App for inventory management reside locally. BI developers will continue to use Excel and Power BI for reporting.](./media/preferred-solution-architecture-oracle-to-postgres-updated.png "Preferred Solution diagram")

    **Diagram of possible architecture:**

    ![The possible architecture includes: Web App for Internet Sales Transactions; the Oracle RAC server connected to Azure Database for PostgreSQL with JSON storage capabilities; and an Oracle Forms App and ASP.NET Core App for inventory management, that are connected. For Excel reporting, the connection string will be changed, and PL/SQL will be rewritten to PL/pgSQL. Power BI will continue to use Direct Query to overcome dataset size limits, the dataset connection string will be rewritten, and Power Query expressions modified accordingly.](media/possible-architecture-oracle-to-postgres-updated.png "Possible architecture")

    **Diagram of how moving pieces will change during the Oracle to Azure Database for PostgreSQL migration:**

    ![Migrate from Oracle, with an Oracle icon and an arrow labeled "ora2pg (schema and data)" that points to Azure Database for PostgreSQL.](./media/oracle-to-postgre-updated.png "Migrate from Oracle")

    **Products that can be used to migrate specific products:**

    ![Products that can be used with Azure Database Migration Service are: SQL Server, Oracle, MySQL, PostgreSQL, mongoDB, and AWS and GCP products.](media/azure-dms-compatibility.png "Azure Database Migration Service (DMS)")

    **Diagram of possible disaster recovery solution:**

    ![With Azure Database for PostgreSQL Single Server, asynchronous physical replication keeps a read replica (located in a separate region) in sync with a primary read/write replica.](./media/single-server-ha.png "Possible disaster recovery solution diagram")

2. What should be included in the POC?

    For the POC we should include the following:

    - An MVC app that changes connectionString from Oracle to PostgreSQL in Entity Framework.

    - A basic form that mirrors what's in the Oracle Forms application.

    - The current Oracle database migrated to Azure Database for PostgreSQL in a test environment.

    - Creating Power BI reports from datasets that point to Azure Database for PostgreSQL.

    - Testing repointing some of the Excel worksheets to a new OLTP database.

    - Implement new features in the new OLTP PostgreSQL database including:
        - JSON Data Store
        - Audit Logs sent to Azure Monitor
  
    - Understand the horizontal scaling functionality of the Hyperscale (Citus) offering and its use cases

3. How will Azure Database for PostgreSQL save them on licensing costs?

    Pricing for Azure Database for PostgreSQL, irrespective of whether it's being used in single-server or Hyperscale (Citus) mode, depends on the amount of resources provisioned for node(s). Billing for compute is conducted by the hour, while storage and backups have a fixed price every month. If you reserve compute resources for a one or three year period, you will receive discounted prices on compute resources. These same rules apply with Hyperscale (Citus), since you specify the resources for your worker nodes and the coordinator node, to which your applications connect. However, unless you exceed the storage capacity of a given node, you will not be charged for backups. The Hyperscale (Citus) offering provides an entry-level *Basic* tier that uses just one node. When the user is ready, they can scale to a *Standard* tier instance with at least two worker nodes and one coordinator node. The API is the exact same between the two tiers.  

    Azure Database for PostgreSQL leverages PostgreSQL Community edition. Nonetheless, using PostgreSQL 11 (the latest supported version of PostgreSQL in Azure for the Single Server product) offers an excellent set of free extensions, including **pgAudit**, which provides auditing functionality. This is in contrast with Oracle, which charges for individual features, like RAC.

    **Note**: To leverage more recent PostgreSQL versions, namely 12 and 13, consider the [Flexible Server (preview) and Hyperscale (Citus) offerings.](https://docs.microsoft.com/azure/postgresql/concepts-version-policy) 

    The PostgreSQL community provides an excellent resource to troubleshoot issues. Nonetheless, a wide variety of experienced companies are available to provide support in every geographic region. On the other hand, Oracle upgrades need Oracle consultants, meaning they take longer, and the consultants charge higher rates. Overall maintenance costs are much higher. These soft changes add to the overall cost of ownership for Oracle environments. 

    > **Note**: The preferred solution is only one of many possible, viable approaches.

*Schema and data movement*

1. How would you recommend that WWI move their data and schema into PostgreSQL? What services would you suggest and what are the specific steps they would need to take to prepare the data, to transfer the data, and where would the loaded data land?

    Ora2pg is a powerful open-source tool that converts an Oracle database schema into a PostgreSQL-compatible one. It provides assessment tools, allowing developers to get a sense of the amount of time that the migration will take. It also can directly copy data into the target database. Note that online migrations, in which the source database processes transactions during the migration procedure, require additional *data sync* complexity. Migration teams can use key columns or creation/modification date columns to facilitate this process. The image below from the Microsoft documentation outlines a basic migration architecture with ora2pg. Secure, reliable networking between the source, VM, and target can be accomplished through ExpressRoute or VPN.

    ![Sample Oracle to Azure Database for PostgreSQL migration with ora2pg. An Azure VM runs the ora2pg tool.](./media/ora2pg-migration-architecture.png "Sample Oracle to Azure Database for PostgreSQL migration setup")

    Note that for on-premises PostgreSQL to Azure Database for PostgreSQL migrations, Azure Database Migration Service can be used. 

    >**Note**: Using DMS requires that you enable the Microsoft.DataMigration resource provider for your subscription.

    DMS, when created with the Premium tier, simplifies on-premises PostgreSQL to Azure Database for PostgreSQL online migrations. The setup steps include creating the schema on the target Azure database (such as by using the `pg_dump` utility) and enabling logical replication on the source. DMS will automatically apply changes made to the source database during the migration to the target. 

2. Update your diagram for the data loading process with the steps you identified.

    See the diagram provided under High-level architecture.

*Application changes*

1. What product would you recommend to WWI to migrate their storefront MVC application to the new PostgreSQL database?

    A specific product might not be needed, but you might evaluate whether they are using an object relational mapping (ORM) tool or not. If they are using Entity Framework, Dapper, or nHibernate, then the application can be migrated much more easily.

    If they didn't use an ORM, then much of the data-layer code will need to be rewritten. If this code is consolidated, and only plain old CLR objects (POCOs) are being handed back using the repository pattern, then we might be able to replace the entire tier with Entity Framework (Core) or another ORM. If there has been bleeding between the layers, then this process might be significantly more difficult. The entire storefront application would need to be refactored and tested eventually. For the POC, they are looking to switch the connection string, test several pages related to an order, and get a good idea on the work that would be necessary to get that to work.

2. How would you migrate the Oracle Forms applications? How would you define success? Are there any technologies the customer needs to know?

    The Oracle Forms application needs to be completely rewritten. There is guidance from Microsoft on how to do that to Visual Basic.NET. There are third-party tools that will attempt to automatically rebuild an Oracle Forms application to Windows Presentation Foundation (WPF) and Model-View-ViewModel (MVVM). You can also rewrite this by hand into any technology the client would like.

    Oracle Forms applications cannot be easily cloud-hosted. This application would eventually need to be rewritten if they'd like new experiences like a mobile experience, a tablet application, or hosted in Microsoft Azure.

3. What will you do about the vendor touchpoints? How will you recommend they store the JSON data?

    The REST services need to be approached the same way the MVC storefront application is approached. If they've used an ORM, then we can repoint the connectionStrings and redeploy.

    JSON data should be stored using the `JSONB` type of PostgreSQL. While PostgreSQL also offers the `JSON` type, the `JSONB` type allows columns storing JSON data to be indexed. In addition, powerful JSON operators simplify complex tasks such as retrieving all JSON data that contains a particular key-value pair.

*Reporting*

1. How can they discover which reports and Excel spreadsheets hitting the Oracle database need to be upgraded? What's a proper upgrade path?

   There is an Oracle Profiler API that can be used to store trace information into tables. These tables can be queried to see if we've identified all reports and artifacts that we need to upgrade.

    We can put individual queries into stored procedures and upgrade them using ora2pg. We can also use ora2pg to upgrade individual queries to PL/pgSQL. While ora2pg provides an excellent upgrade jump start, some additional code changes may be required.

*High Availability and Audit Table*

1. If our solution were PostgreSQL, what could WWI have done with the audit table when it filled up?

    PostgreSQL's logging tools and pgAudit export events in .log files. Azure Database for PostgreSQL has the ability to export these files as JSON for storage in Azure Monitor. Log files are created hourly or once their contents reach 100 MB in size. In Azure Monitor, logs can be analyzed and visualized through Kusto Query Language (KQL) queries.

    Alternatively, if this feature is not enabled, Azure Database for PostgreSQL stores logs in a 1 GB area. If this area becomes fully populated, the oldest files in the region will be deleted. Otherwise, logs will be deleted once their retention period ends, which by default is 3 days.

2. What are the PostgreSQL options for high availability?

    PostgreSQL provides several options for creating high availability for a server or database. High-availability options in Azure include the following:

    - Replication options
      - With Single Server, a configured read-only instance can be promoted to read/write capacity 
    - Hyperscale (Citus) also supports HA
      - Hyperscale (Citus) can cluster two instances to serve as a single node with automatic failover (no data loss)
      - Hyperscale (Citus) shards databases, and each shard is stored in multiple locations throughout the cluster
    - Log shipping

*Azure Database for PostgreSQL POC*

1. Should they move to on-premises first?

    It is certainly possible to run PostgreSQL locally. However, implementing the high availability and performance features of an Azure offering locally would be significantly more difficult than using Azure's managed service.

    Other on-premises applications might keep them on-premises until they can figure out how to move those applications to the cloud. It depends on the integration touchpoints, network latency needs, and reliable internet connectivity for all offices.

2. Is there any benefit to going straight to Microsoft Azure? Does Azure Database for PostgreSQL take care of all of their requirements?

    If the organization has chosen to go to the cloud, then this will be a long-term way to ensure cost savings by not purchasing on-premises hardware.

    If the applications are already cloud-based, or they have many external applications needing access, then this would not affect latency while removing the burden from WWI of maintaining the connectivity with all their integration partners.

    In addition, they would gain the benefit of simplifying future software upgrades. Some of their products would upgrade and offer new features with minimal effort on their part.

3. Are there any questions we need to answer before we can begin a POC directly to Microsoft Azure?

    - What is network connectivity like between on-premises and the cloud?
    - What are our long-term cloud plans? Is there a mandate to go there regardless?
    - Where is the rest of the data integration points stored? Are they on-premises? Is anything in Microsoft Azure already?
    - Are there any cloud products that are already on the roadmap for the organization?

## Checklist of preferred objection handling

1. Do we need to upgrade to on-premises PostgreSQL first or go can we go straight to Azure?

    This is a joint business and technical decision. Azure Database for PostgreSQL (single server or Hyperscale) or PostgreSQL in a VM will offer all the features they've stated that they need. There is a migration path to both.

    If they have a long-term strategy to move to the cloud, have already moved some resources there, have a plan to co-locate with a partner data center, or have identified cloud services they'd like to take advantage of, then moving straight to the cloud might be preferred.

    It might be easier to be on-premises if they don't have ExpressRoute for their Excel spreadsheets and other on-premises resources that can't migrate to Azure quite yet.

2. Can we have two proofs of concept that demonstrate both migrations?

    Two proofs of concept are possible and easy to do. The application architecture might be quite a bit different if we choose to use Platform as a Service (PaaS). The online sales application and web services would migrate to Azure Websites. The changes made to existing Excel and Power BI reports would be minor. 

3. Do we need to rewrite all our applications for Azure Database for PostgreSQL?

    The Oracle Forms application would have to be rewritten to ASP.NET Core or ASP.NET MVC. There are third-party migration tools available to help if they choose to migrate to ASP.NET MVC. Otherwise, the rewrite effort will need to be planned and implemented. For the POC, show a basic CRUD data entry form to show how the project would be structured. Use Entity Framework (Core) if appropriate to make the CRUD migration easier.

    If the existing ASP.NET MVC application that runs their storefront uses Entity Framework or another object-relational mapping (ORM) tool, then migration of that application is trivial. It's possible that we could repoint the connectionString, re-run the unit tests, and the application will just work. Blockers might be if Entity Framework is using Stored Procedures in Oracle. Those will need to be tested after we run ora2pg to migrate them. PostgreSQL 11 does support stored procedures, but if the stored procedure returns a result set through a cursor, porting the logic to a function is preferable.

4. Do we need to rewrite all our reports for Azure Database for PostgreSQL?

    The Power BI reports should migrate over with just a change to the connectionString. Power Query code may need to be modified. 

    If the Excel reports use simple queries to views or stored procedures, then changing the connectionString might work with them, also. If not, then the queries that drive the spreadsheets will need to be rewritten. ora2pg can also convert specific, individual queries from PL/SQL to PL/pgSQL.

5. Will our security migrate over from Oracle to PostgreSQL? How do we handle security in the new database?

    Ora2pg does have the ability to migrate privileges granted to users. However, note that security concepts in Oracle differ from PostgreSQL. For instance, roles in PostgreSQL are not database-scoped; if a role has the privileges to do so, it can manipulate data in more than one database.

6. Do we need to invest in a JSON storage system for the JSON data we're storing from our vendor's web service?

    JSON data can be stored in PostgreSQL as a `JSONB` field. While inserting data does take longer than if the `JSON` type was used instead, querying data is significantly faster. Power BI is compatible with JSON data.     

7. What will we do if our audit logs fill up again? Will PostgreSQL crash the same way Oracle did?

    Storing .log files in Azure Monitor is the best solution to facilitate the storage and analysis of logs. Nonetheless, even if logs are stored on the instances themselves, if their cumulative size exceeds 1 GB, the oldest logs will be removed, even if the retention period has not yet expired. So crashes can't occur from this.

8. If we take advantage of new features, will our license costs keep ratcheting up and up? Will we have a dependable way of budgeting for this project?

    As mentioned previously, Microsoft has a transparent budgeting system with various options to optimize costs. Support for a wide range of extensions allows you to easily implement features to meet the organization's data needs. You also have access to reserved pricing, which reduces the amount you spend hourly for compute resources.  

9. Are there any Oracle features required by WWI for which PostgreSQL Server has no equivalent?

    Nothing in the customer requirements is exclusive to an Oracle ecosystem. Oracle Forms is unique to Oracle, but Microsoft offers several replacement technologies, including LightSwitch, SharePoint Forms, Power Apps, ASP.NET MVC, WPF Forms, and ASP.NET Core applications.

    The customer might implement Oracle RAC, but managed Azure Database for PostgreSQL - Hyperscale (Citus) is simpler to provision and manage, follows a simpler pricing model, and offers excellent performance and high availability features. Hyperscale (Citus) is well-suited to multi-tenant applications and analytics platforms (through new features, like compressed column storage). WWI should discuss whether their future growth necessitates a database optimized for horizontal scaling and large workloads (100 GB+).

10. Do we need to tell all our vendors that we're changing databases, so their integrations work?

    As long as we test and refactor the web services they use, they shouldn't know that you switched your back-end data store.

11. What will happen with Power BI?

    Developers can connect to Azure Database for PostgreSQL from Power BI desktop. It is now possible to leverage DirectQuery to connect to Azure Database for PostgreSQL from Power BI Service.

## Customer quote (to be read back to the attendees at the end)

"We are excited that a PostgreSQL environment will help our organization grow and prosper for many years into the future."

Kathleen Sloan, CIO of World Wide Importers
