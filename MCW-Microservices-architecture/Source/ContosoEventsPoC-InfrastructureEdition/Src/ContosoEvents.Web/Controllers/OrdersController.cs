using ContosoEvents.Web.Helpers;
using ContosoEvents.Web.Models;
using ContosoEvents.Web.Models.Api;
using System;
using System.Security.Claims;
using System.Web.Mvc;

namespace ContosoEvents.Web.Controllers
{
    public class OrdersController : Controller
    {
        public ActionResult Index()
        {
            var orders = ContosoEventsApi.GetUserOrders(ClaimsPrincipal.Current.GetUserId());

            return View(orders);
        }

        [HttpPost]
        public ActionResult PlaceOrder(string id, NewOrder order)
        {
            var result = true;
            string orderId = null;

            var eventData = ContosoEventsApi.GetEvent(id);
            if (eventData == null)
            {
                result = false;
            }
            else
            {
                var data = new OrderRequest
                {
                    OrderDate = DateTime.UtcNow,
                    UserName = ClaimsPrincipal.Current?.GetUserId(),
                    Email = ClaimsPrincipal.Current?.Identity?.Name,
                    EventId = eventData.Id,
                    PaymentProcessorTokenId = string.IsNullOrWhiteSpace(order.PaymentProcessorToken) ? Guid.NewGuid().ToString(): order.PaymentProcessorToken, //We need to send a payment processor token
                    Tickets = order.TicketCount
                };
                if (string.IsNullOrWhiteSpace(data.Email)) data.Email = order.DeliveryEmail;
                if (string.IsNullOrWhiteSpace(data.UserName)) data.UserName = order.DeliveryEmail;
                if (string.IsNullOrWhiteSpace(data.FirstName)) data.FirstName = order.FirstName;
                if (string.IsNullOrWhiteSpace(data.LastName)) data.LastName = order.LastName;

                var placeUserOrderResult = ContosoEventsApi.PlaceUserOrder(data);
                result = placeUserOrderResult.Item1;
                orderId = placeUserOrderResult.Item2;
            }

            return View("OrderResult", new Tuple<bool, string>(result, orderId));
        }

        public ActionResult Details(string id)
        {
            var data = ContosoEventsApi.GetOrder(id);

            return View(data);
        }

        public ActionResult Cancel(string id)
        {
            ContosoEventsApi.CancelUserOrder(id);

            return RedirectToAction("Index");
        }
    }
}